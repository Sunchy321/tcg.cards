<template>
    <q-layout view="hHh Lpr fFf">
        <q-header elevated>
            <q-toolbar>
                <q-btn icon="mdi-home" flat dense @click="toHome" />

                <q-toolbar-title>
                    {{ title }}
                </q-toolbar-title>

                <q-btn-dropdown class="q-btn-locale" dense flat :label="locale">
                    <q-list link>
                        <q-item
                            v-for="l in locales"
                            :key="l"
                            v-close-popup
                            clickable
                            @click="locale = l"
                        >
                            <q-item-section side>
                                {{ l }}
                            </q-item-section>
                            <q-item-section>
                                {{
                                    $t('lang.' + l)
                                }}
                            </q-item-section>
                        </q-item>
                    </q-list>
                </q-btn-dropdown>

                <q-btn
                    v-if="isAdmin && game != null"
                    icon="mdi-database"
                    flat dense
                    @click="toData"
                />

                <q-btn
                    :icon="user != null ? 'mdi-cog' : 'mdi-cog-outline'"
                    flat
                    dense
                    @click="toSetting"
                />
            </q-toolbar>
        </q-header>

        <q-page-container>
            <q-ajax-bar />
            <router-view />
        </q-page-container>
    </q-layout>
</template>

<style lang="stylus" scoped>
.q-btn-locale
    text-transform none !important
</style>

<script>
import basic from '../mixins/basic';

import { format } from 'quasar';

export default {
    name: 'Main',

    mixins: [basic],

    computed: {
        locale: {
            get() {
                return this.$store.getters['locale/value'];
            },

            set(newValue) {
                this.$store.commit('locale/set', newValue);
            },
        },

        locales() {
            return this.$store.getters['locale/values'];
        },

        title() {
            const titleMatch = this.$route.matched.find(
                r => r.meta.title != null,
            );

            if (titleMatch != null) {
                return format.capitalize(this.$t(titleMatch.meta.title));
            } else {
                const regex = /\//g;
                return this.$route.path.slice(1).replace(regex, '.');
            }
        },

        dataPath() {
            if (this.isAdmin && this.game != null) {
                return `/${this.game}/data`;
            } else {
                return null;
            }
        },
    },

    methods: {
        toHome() {
            if (this.game && this.$route.path !== '/' + this.game) {
                this.$router.push('/' + this.game);
            } else {
                this.$router.push('/');
            }
        },

        toData() {
            if (this.game != null) {
                this.$router.push(`/${this.game}/data`);
            }
        },

        toSetting() {
            this.$router.push('/setting');
        },
    },
};
</script>
